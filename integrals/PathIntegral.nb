(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 13.2' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     11405,        321]
NotebookOptionsPosition[     10552,        300]
NotebookOutlinePosition[     10947,        316]
CellTagsIndexPosition[     10904,        313]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{
Cell[BoxData[{
 RowBox[{
  RowBox[{"sLimits", "[", "k_", "]"}], ":=", " ", 
  RowBox[{"Join", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"s", "[", "k", "]"}], ",", "0", ",", "t"}], "}"}], "}"}], ",", 
    
    RowBox[{"Reverse", "[", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"s", "[", "j", "]"}], ",", "0", ",", 
         RowBox[{"s", "[", 
          RowBox[{"j", "+", "1"}], "]"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"j", ",", "1", ",", 
         RowBox[{"k", "-", "1"}]}], "}"}]}], "]"}], "]"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"integrand", ":=", 
   RowBox[{"Exp", "[", 
    RowBox[{"Sum", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"a", "[", "i", "]"}], 
       RowBox[{"s", "[", "i", "]"}]}], ",", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "3"}], "}"}]}], "]"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"coeffsToExpr", "[", 
   RowBox[{"{", "}"}], "]"}], ":=", 
  RowBox[{"{", "}"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"coeffsToExpr", "[", "coeffs_", "]"}], ":=", 
  RowBox[{"Fold", "[", 
   RowBox[{"Plus", ",", 
    RowBox[{
     RowBox[{
      RowBox[{"a", "[", "#", "]"}], "&"}], "/@", "coeffs"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"setToExprs", "[", "set_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"coeffsToExpr", "[", "#", "]"}], "&"}], "/@", "#"}], "&"}], "/@",
     "set"}]}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"TODO", ":", " ", 
    RowBox[{
    "does", " ", "this", " ", "set", " ", "to", " ", "exprs", " ", "make", 
     " ", 
     RowBox[{"sense", "?"}]}]}], "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"setToExprs", "[", 
    RowBox[{"sets_", ",", "k_"}], "]"}], ":=", 
   RowBox[{"setToExprs", "[", 
    RowBox[{"Reverse", "[", 
     RowBox[{"Sort", "[", 
      RowBox[{"sets", "[", "k", "]"}], "]"}], "]"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"allZero", "[", "set_", "]"}], ":=", 
  RowBox[{"AllTrue", "[", 
   RowBox[{"set", ",", 
    RowBox[{
     RowBox[{"#", "==", "0"}], "&"}]}], "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getMatchingExpression", "[", 
    RowBox[{"expressions_", ",", "rules_"}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"First", "[", 
    RowBox[{
     RowBox[{"Select", "[", 
      RowBox[{"expressions", ",", 
       RowBox[{
        RowBox[{"allZero", "[", 
         RowBox[{"#", "/.", "rules"}], "]"}], "&"}]}], "]"}], ",", 
     RowBox[{"{", "}"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"genRules", "[", 
   RowBox[{"sTerm_", ",", "expressions_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"#", "->", "0"}], "&"}], "/@", 
   RowBox[{"Expand", "[", 
    RowBox[{"sTerm", " ", "expressions"}], "]"}]}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"genRules", "[", "expressions_", "]"}], ":=", 
   RowBox[{
    RowBox[{
     RowBox[{"#", "->", "0"}], "&"}], "/@", " ", "expressions"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"integrateExpandReplace", "[", 
    RowBox[{"integrand_", ",", "limits_", ",", "replaceTerms_"}], "]"}], ":=",
    "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Expand", "[", 
     RowBox[{"Integrate", "[", 
      RowBox[{"integrand", ",", "limits"}], "]"}], "]"}], "/.", 
    RowBox[{"genRules", "[", 
     RowBox[{
      RowBox[{"limits", "[", 
       RowBox[{"[", "3", "]"}], "]"}], ",", "replaceTerms"}], "]"}]}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"integrateLastTerm", "[", 
    RowBox[{"integrand_", ",", "k_"}], "]"}], ":=", 
   RowBox[{"Integrate", "[", 
    RowBox[{"integrand", ",", 
     RowBox[{"First", "[", 
      RowBox[{"Take", "[", 
       RowBox[{
        RowBox[{"sLimits", "[", "k", "]"}], ",", "1"}], "]"}], "]"}]}], 
    "]"}]}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"integrateReplaceTerms", "[", 
    RowBox[{"terms_", ",", "integrand_", ",", "k_"}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"integrateLastTerm", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"Fold", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"integrateExpandReplace", "[", 
         RowBox[{"#1", ",", "#2", ",", 
          RowBox[{"getPolyTerms", "[", "terms", "]"}]}], "]"}], "&"}], ",", 
       RowBox[{"integrand", "/.", 
        RowBox[{"genRules", "[", 
         RowBox[{"getSingleTerms", "[", "terms", "]"}], "]"}]}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{"Drop", "[", 
        RowBox[{
         RowBox[{"Reverse", "[", 
          RowBox[{"sLimits", "[", "k", "]"}], "]"}], ",", 
         RowBox[{"-", "1"}]}], "]"}]}], "]"}], ",", "k"}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getSingleTerms", "[", "terms_", "]"}], ":=", 
  RowBox[{"Select", "[", 
   RowBox[{"terms", ",", 
    RowBox[{
     RowBox[{
      RowBox[{"Length", "[", "#", "]"}], "==", "1"}], "&"}]}], 
   "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"getPolyTerms", "[", "terms_", "]"}], ":=", 
   RowBox[{"Select", "[", 
    RowBox[{"terms", ",", 
     RowBox[{
      RowBox[{
       RowBox[{"Length", "[", "#", "]"}], ">", "1"}], "&"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"computeTimeIntegrals", "[", 
   RowBox[{"sets_", ",", "k_"}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"<|", 
   RowBox[{
    RowBox[{
     RowBox[{"#", "->", 
      RowBox[{"integrateReplaceTerms", "[", 
       RowBox[{"#", ",", "integrand", ",", "k"}], "]"}]}], "&"}], "/@", 
    "sets"}], "|>"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"computeTimeIntegralsParallel", "[", 
    RowBox[{"sets_", ",", "k_"}], "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"AssociationThread", "[", 
    RowBox[{"sets", ",", 
     RowBox[{"ParallelMap", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"integrateReplaceTerms", "[", 
         RowBox[{"#", ",", "integrand", ",", "k"}], "]"}], "&"}], ",", 
       "sets"}], "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"getMatchingIntegral", "[", 
   RowBox[{"integrals_", ",", "sets_", ",", "rules_"}], "]"}], ":=", 
  "\[IndentingNewLine]", 
  RowBox[{"timeIntegrals", "[", 
   RowBox[{"getMatchingExpression", "[", 
    RowBox[{"sets", ",", " ", "rules"}], "]"}], "]"}]}]}], "Input",
 CellChangeTimes->{{3.905434135841861*^9, 3.905434174598714*^9}, {
   3.905434212453377*^9, 3.9054342228824673`*^9}, {3.905434314740837*^9, 
   3.905434314960478*^9}, {3.905438212020987*^9, 3.9054382680897408`*^9}, {
   3.905438306664339*^9, 3.905438306934722*^9}, 3.9054398342098827`*^9, {
   3.905439920252207*^9, 3.905439944581883*^9}, {3.9054405817057734`*^9, 
   3.905440598494849*^9}, {3.905440923496448*^9, 3.9054409246347857`*^9}, {
   3.905526680696969*^9, 3.905526684663547*^9}, {3.9055282888314133`*^9, 
   3.90552842842134*^9}, {3.905528466498312*^9, 3.905528468364703*^9}, {
   3.905528546541091*^9, 3.905528548194499*^9}, {3.905532075741102*^9, 
   3.905532088586645*^9}},ExpressionUUID->"2ece0305-c625-4338-817b-\
9fabbf2feac3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"Get", "[", 
   RowBox[{"FileNameJoin", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"NotebookDirectory", "[", "]"}], ",", "\"\<out\>\"", ",", 
      "\"\<sets.m\>\""}], "}"}], "]"}], "]"}], ";"}]], "Input",
 CellChangeTimes->{{3.905439871926235*^9, 3.90543987291228*^9}, 
   3.905439925547037*^9, 3.905440573566423*^9, {3.9055207482004833`*^9, 
   3.905520749370788*^9}},
 CellLabel->"In[16]:=",ExpressionUUID->"55fc1796-a311-4a15-bc44-70fe193c6fbe"],

Cell[BoxData[{
 RowBox[{"kTerms", ":=", "5"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"(", 
     RowBox[{
      RowBox[{"expressions", "[", "#", "]"}], "=", 
      RowBox[{"setToExprs", "[", 
       RowBox[{"sets", ",", "#"}], "]"}]}], ")"}], "&"}], "/@", 
   RowBox[{"Range", "[", "kTerms", "]"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.905440902321458*^9, 3.9054409087025223`*^9}, {
  3.905440947827417*^9, 3.905441028287571*^9}, {3.90552074120444*^9, 
  3.905520804280189*^9}},
 CellLabel->"In[19]:=",ExpressionUUID->"69da9964-719b-4a35-a201-9aef59e860e6"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"<|", 
  RowBox[{
   RowBox[{
    RowBox[{"#", "->", 
     RowBox[{"Length", "[", 
      RowBox[{"expressions", "[", "#", "]"}], "]"}]}], "&"}], "/@", 
   RowBox[{"Range", "[", "kTerms", "]"}]}], "|>"}]], "Input",
 CellChangeTimes->{{3.905520766610417*^9, 3.905520789790742*^9}, {
  3.9055208235700397`*^9, 3.9055208427895117`*^9}, {3.905520879452883*^9, 
  3.9055208867873793`*^9}},
 CellLabel->"In[21]:=",ExpressionUUID->"04d55995-1fec-4f10-85cb-51e3e2021fb5"],

Cell[BoxData[
 RowBox[{"\[LeftAssociation]", 
  RowBox[{
   RowBox[{"1", "\[Rule]", "2"}], ",", 
   RowBox[{"2", "\[Rule]", "5"}], ",", 
   RowBox[{"3", "\[Rule]", "19"}], ",", 
   RowBox[{"4", "\[Rule]", "167"}], ",", 
   RowBox[{"5", "\[Rule]", "7004"}]}], "\[RightAssociation]"}]], "Output",
 CellChangeTimes->{{3.9055207816610117`*^9, 3.905520790300294*^9}, 
   3.905520845213552*^9, 3.905520887154047*^9, 3.905525997082862*^9, 
   3.9055260519245853`*^9, 3.9055286187910357`*^9},
 CellLabel->"Out[21]=",ExpressionUUID->"3c441b03-66ac-496c-be13-bdd8b319a71e"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"timeIntegrals", "=", 
   RowBox[{"computeTimeIntegralsParallel", "[", 
    RowBox[{
     RowBox[{"expressions", "[", "3", "]"}], ",", "3"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.90552595662469*^9, 3.905525959580838*^9}, 
   3.9055321109347677`*^9},ExpressionUUID->"b82e54af-823a-4850-9559-\
a4dbf884f728"]
},
WindowSize->{810, 1440},
WindowMargins->{{Automatic, -810}, {Automatic, 0}},
FrontEndVersion->"13.2 for Linux x86 (64-bit) (December 7, 2022)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"204f1021-71cb-4e2e-a7ba-745292f6ef6a"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[558, 20, 7455, 209, 800, "Input",ExpressionUUID->"2ece0305-c625-4338-817b-9fabbf2feac3"],
Cell[8016, 231, 492, 11, 29, "Input",ExpressionUUID->"55fc1796-a311-4a15-bc44-70fe193c6fbe"],
Cell[8511, 244, 592, 14, 51, "Input",ExpressionUUID->"69da9964-719b-4a35-a201-9aef59e860e6"],
Cell[CellGroupData[{
Cell[9128, 262, 485, 11, 29, "Input",ExpressionUUID->"04d55995-1fec-4f10-85cb-51e3e2021fb5"],
Cell[9616, 275, 563, 11, 33, "Output",ExpressionUUID->"3c441b03-66ac-496c-be13-bdd8b319a71e"]
}, Open  ]],
Cell[10194, 289, 354, 9, 29, "Input",ExpressionUUID->"b82e54af-823a-4850-9559-a4dbf884f728"]
}
]
*)

